---
import { ICONS } from "@/icons/icons.astro";

type TechName = keyof typeof ICONS;

interface TechIcon {
  name: TechName;
  component: (props: any) => any;
}

const techStack: TechIcon[] = Object.entries(ICONS).map(
  ([name, component]) => ({
    name: name as TechName,
    component,
  }),
);

const generateBackgroundPattern = (iconCount: number, cols: number) => {
  const pattern = [];
  let lastIndex = -1;

  for (let i = 0; i < iconCount; i++) {
    let selectedIndex;
    do {
      selectedIndex = Math.floor(Math.random() * techStack.length);
    } while (selectedIndex === lastIndex && techStack.length > 1);

    pattern.push({
      ...techStack[selectedIndex],
      position: {
        row: Math.floor(i / cols),
        col: i % cols,
      },
    });
    lastIndex = selectedIndex;
  }

  return pattern;
};

const backgroundPattern = generateBackgroundPattern(120, 12);
---

<div
  id="hero-tech-background"
  class="absolute inset-x-0 top-16 bottom-0 pointer-events-none z-0 md:block hidden"
  aria-hidden="true"
>
  <div
    class="absolute inset-0 grid grid-cols-12 gap-4 p-6"
    style="grid-template-rows: repeat(10, minmax(0, 1fr));"
  >
    {
      backgroundPattern.map(
        ({ component: IconComponent, name, position }, index) => (
          <div
            class="hero-tech-icon flex items-center justify-center grayscale transition-all duration-500 ease-out p-2"
            style={{
              gridColumn: position.col + 1,
              gridRow: position.row + 1,
              animationDelay: `${index * 50}ms`,
              opacity: "0.05",
            }}
            data-tech={name}
          >
            <IconComponent class="w-8 h-8 lg:w-12 lg:h-12 text-four" />
          </div>
        ),
      )
    }
  </div>
</div>

<script type="module">
  document.addEventListener("DOMContentLoaded", () => {
    const icons = document.querySelectorAll(".hero-tech-icon");
    const container = document.getElementById("hero-tech-background");
    const isDesktop = window.matchMedia("(min-width: 768px)").matches;

    if (!container || !icons.length || !isDesktop) return;

    container.style.pointerEvents = "auto";

    const handleMouseMove = (event) => {
      const rect = container.getBoundingClientRect();
      const mouseX = event.clientX - rect.left;
      const mouseY = event.clientY - rect.top;

      icons.forEach((icon) => {
        const iconRect = icon.getBoundingClientRect();
        const iconX = iconRect.left + iconRect.width / 2 - rect.left;
        const iconY = iconRect.top + iconRect.height / 2 - rect.top;

        const distance = Math.sqrt(
          Math.pow(mouseX - iconX, 2) + Math.pow(mouseY - iconY, 2),
        );

        const maxDistance = 200;
        const proximity = Math.pow(Math.max(0, 1 - distance / maxDistance), 3);

        if (proximity > 0.01) {
          icon.style.opacity = (0.02 + proximity * 0.95).toString();
          icon.style.filter = `grayscale(${100 - proximity * 100}%) drop-shadow(0 0 ${10 + proximity * 50}px rgba(94, 145, 242, ${0.3 + proximity * 0.7})) drop-shadow(0 0 ${5 + proximity * 25}px rgba(147, 184, 255, ${proximity * 0.8}))`;
          icon.style.transform = `scale(${1 + proximity * 0.5})`;
          icon.style.zIndex = "10";
        } else {
          icon.style.opacity = "0.02";
          icon.style.filter = "grayscale(100%)";
          icon.style.transform = "scale(1)";
          icon.style.zIndex = "";
        }
      });
    };

    const handleMouseLeave = () => {
      icons.forEach((icon) => {
        icon.style.opacity = "0.02";
        icon.style.filter = "grayscale(100%)";
        icon.style.transform = "scale(1)";
        icon.style.zIndex = "";
      });
    };

    container.addEventListener("mousemove", handleMouseMove);
    container.addEventListener("mouseleave", handleMouseLeave);
  });
</script>

<style>
  @keyframes heroTechFloat {
    0%,
    100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-6px);
    }
  }

  .hero-tech-icon {
    animation: heroTechFloat 8s ease-in-out infinite;
  }

  .hero-tech-icon:nth-child(3n) {
    animation-delay: 2s;
    animation-duration: 10s;
  }

  .hero-tech-icon:nth-child(3n + 1) {
    animation-delay: 4s;
    animation-duration: 7s;
  }

  .hero-tech-icon:nth-child(3n + 2) {
    animation-delay: 6s;
    animation-duration: 9s;
  }
</style>
